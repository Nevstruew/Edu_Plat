{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-body">
            <h1 class="card-title">{{ lesson.title }}</h1>
            <p class="text-muted">–ö—É—Ä—Å: {{ lesson.course.title }}</p>
            <div class="lesson-content">
                {{ lesson.content|linebreaks }}
            </div>
        </div>
    </div>

    <!-- –ë–õ–û–ö –ó–ê–î–ê–ù–ò–ô -->
    <div class="assignments-section">
        <h2>üìù –ó–∞–¥–∞–Ω–∏—è —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞</h2>
        
        {% if assignments %}
            <div class="row">
                {% for assignment in assignments %}
                <div class="col-md-6 mb-3">
                    <div class="card assignment-card">
                        <div class="card-body">
                            <h5 class="card-title">{{ assignment.title }}</h5>
                            <p class="card-text">{{ assignment.description|truncatewords:20 }}</p>
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
                            {% with user_submission=assignment.submissions.all|first %}
                            
                            {% if user.is_authenticated %}
                                <!-- –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–¨ –Ω–µ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–æ–∫ –æ—Ç–≤–µ—Ç–∞ -->
                                {% if user == lesson.created_by %}
                                    <!-- –ü—É—Å—Ç–æ - –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∏—Ç –∑–∞–¥–∞–Ω–∏—è –±–µ–∑ –∫–Ω–æ–ø–æ–∫ -->
                                
                                <!-- –°–¢–£–î–ï–ù–¢ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∞ -->
                                {% else %}
                                    {% if user_submission and user_submission.student == user %}
                                        <div class="alert alert-success p-2">
                                            <small>‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</small>
                                            {% if user_submission.grade %}
                                                <br><small>–û—Ü–µ–Ω–∫–∞: {{ user_submission.grade }}/100</small>
                                            {% endif %}
                                        </div>
                                        <a href="{% url 'submission_detail' user_submission.id %}" 
                                           class="btn btn-outline-primary btn-sm">
                                            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–≤–µ—Ç
                                        </a>
                                    {% else %}
                                        <a href="{% url 'assignment_detail' assignment.id %}" 
                                           class="btn btn-success btn-sm">
                                            ‚úèÔ∏è –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ
                                        </a>
                                    {% endif %}
                                {% endif %}
                                
                            {% else %}
                                <!-- –ù–ï–ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–ô –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                                <a href="{% url 'login' %}" class="btn btn-warning btn-sm">
                                    –í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å
                                </a>
                            {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                –í —ç—Ç–æ–º —É—Ä–æ–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞–Ω–∏–π.
            </div>
        {% endif %}
    </div>

    <!-- –ë–õ–û–ö –î–õ–Ø –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–Ø -->
    {% if user == lesson.created_by %}
    <div class="teacher-section mt-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">üë®‚Äçüè´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–∫–æ–º</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    {% for assignment in assignments %}
                    <a href="{% url 'assignment_submissions' assignment.id %}" 
                       class="btn btn-warning">
                        üìä –û—Ç–≤–µ—Ç—ã: {{ assignment.title }} ({{ assignment.submissions.count }})
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î -->
    <div class="mt-3">
        <a href="{% url 'lesson_list' %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —É—Ä–æ–∫–∞–º</a>
    </div>
</div>
{% endblock %}